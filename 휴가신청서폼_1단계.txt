<!DOCTYPE html>
<html>
<head>
    <title>íœ´ê°€ì‹ ì²­ì„œ</title>
    <!-- Bootstrap CSS ì¶”ê°€ -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h4>íœ´ê°€ì‹ ì²­ì„œ ì‘ì„±í•˜ê¸°</h4>
    <small>#ì‹ ì²­ìˆœì„œ: ì‚¬ë²ˆì…ë ¥í™•ì¸ > ì´ë¦„í™•ì¸ > íœ´ê°€ì¼ì •ì…ë ¥(ì¶”ê°€) > ì œì¶œí•˜ê¸°</small>
    <hr>
    <form id="vacationForm">
        <div class="form-group">
            <label for="employeeId">ğŸ¤·â€â™‚ï¸ì‚¬ë²ˆì…ë ¥ í›„ í™•ì¸ë°”ëë‹ˆë‹¤</label>
            <input type="number" class="form-control" id="employeeId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" name="employeeId" required>
            <button id="searchName" class="btn btn-secondary mt-2">âœ”í™•ì¸</button>
        </div>
        <div class="form-group">
            <label for="name">âœ”ì‚¬ë²ˆì´ í™•ì¸ë˜ë©´ ì•„ë˜ ì´ë¦„ì´ ì…ë ¥ ë©ë‹ˆë‹¤</label>
            <input type="text" class="form-control" id="name" name="name" disabled>
        </div>
        <div class="form-group">
            <label>âœ¨íœ´ê°€ì‹ ì²­ì¼:</label>
            <div id="dateContainer">
                <div class="date-input-group mb-2">
                    <input type="date" class="form-control" name="vacationDate" required>
                    <button class="btn btn-secondary btn-sm ml-2 remove-date">âŒì‚­ì œ</button>
                </div>
            </div>
            <button id="addDate" class="btn btn-info btn-sm">â•ì¶”ê°€</button>
        </div>
        <div class="form-group">
            <label for="notes">ğŸ’¬ê¸°íƒ€ì°¸ê³ ì‚¬í•­:</label>
            <textarea class="form-control" id="notes" name="notes"></textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-block">ğŸš€ì œì¶œí•˜ê¸°</button>
    </form>
   </div>
<div class="container mt-5">
      <h5 class="mb-3">ğŸ”íœ´ê°€ ì‹ ì²­ë‚´ì—­ ì¡°íšŒí•˜ê¸°</h5>
      <!-- <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text">ì‚¬ë²ˆ:</span>
        </div>
        <input type="text" class="form-control" id="employeeId"> -->
        <div class="input-group-append">
          <button class="btn btn-primary" onclick="searchRequests()">ğŸ”ì¡°íšŒ í•˜ê¸°</button>
        </div>
      </div>
      <ul id="results" class="list-group" style="margin:10px;"></ul>
    </div>
    <script>
  function searchRequests() {
    var employeeId = document.getElementById('employeeId').value;
    if (employeeId.length === 0) {
    alert("ğŸ¤·â€â™‚ï¸ìƒë‹¨ì— ì‚¬ë²ˆì„ ì…ë ¥í›„ ì¡°íšŒí•˜ì„¸ìš”");
    return;
  }
    google.script.run.withSuccessHandler(displayResults).getVacationRequests(employeeId);
    alert("ğŸ¤·â€â™‚ï¸ì‹ ì²­ë‚´ì—­ (ì¬)ì¡°íšŒì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”");
  }

  function displayResults(requests) {
  var results = document.getElementById('results');
  results.innerHTML = '';

  
  if (requests.length === 0) {
    var li = document.createElement('li');
    li.textContent = "ğŸ¤·â€â™‚ï¸í˜„ì¬, ì‹ ì²­ë‚´ì—­ì´ ì¡°íšŒ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤";
    li.className = 'list-group-item';
    results.appendChild(li);
    window.scrollTo(0, document.body.scrollHeight);
  } else {
    for (var i = 0; i < requests.length; i++) {
      var li = document.createElement('li');
      li.textContent = requests[i];
      li.className = 'list-group-item';
      results.appendChild(li);
    }
    // ìŠ¤í¬ë¡¤ë°”ë¥¼ ë§¨ ì•„ë˜ë¡œ ì´ë™
    window.scrollTo(0, document.body.scrollHeight);
  }
}
</script>

<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  document.getElementById('searchName').addEventListener('click', function(e) {
    e.preventDefault(); // ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì œì¶œ ë°©ì§€
    var employeeId = document.getElementById('employeeId').value;
    
    google.script.run.withSuccessHandler(function(name) {
      var nameInput = document.getElementById('name');
      if (name) {
        nameInput.value = name;
      } else {
        nameInput.value = "ğŸ¤·â€â™‚ï¸ì…ë ¥ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¼ì¹˜í•˜ëŠ” ì´ë¦„ ì—†ìŠµë‹ˆë‹¤. ì‚¬ë²ˆì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      }
    }).getNameByEmployeeId(employeeId);
  });

  document.getElementById('addDate').addEventListener('click', function(e) {
    e.preventDefault(); // ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì œì¶œ ë°©ì§€

    var dateInputGroup = document.createElement('div');
    dateInputGroup.className = 'date-input-group mb-2';

    var dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.className = 'form-control';
    dateInput.name = 'vacationDate';
    dateInputGroup.appendChild(dateInput);

    var removeButton = document.createElement('button');
    removeButton.className = 'btn btn-secondary btn-sm ml-2 remove-date';
    removeButton.textContent = 'âŒì‚­ì œ';
    removeButton.addEventListener('click', function(e) {
      e.preventDefault();
      dateInputGroup.remove();
    });
    dateInputGroup.appendChild(removeButton);

    document.getElementById('dateContainer').appendChild(dateInputGroup);
  });

  // ì´ˆê¸° ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
  document.querySelectorAll('.remove-date').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      button.parentElement.remove();
    });
  });

  // íœ´ê°€ì‹ ì²­ì„œ ì œì¶œ ì‹œ
  document.getElementById('vacationForm').addEventListener('submit', function(e) {
    e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€

    var employeeId = document.getElementById('employeeId').value;
    var dateInputs = document.querySelectorAll('input[name="vacationDate"]');
    var dates = [];

    dateInputs.forEach(function(input) {
      if (input.value) {
        dates.push(input.value);
      }
    });
    // í•„ìˆ˜ í•­ëª© í™•ì¸
  if (!employeeId || dates.length === 0) {
    alert("ì‚¬ë²ˆ ë° íœ´ê°€ì¼ì •ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
    return;
  }
    // íœ´ê°€ ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ì¤‘ì„ì„ ì•Œë¦¬ëŠ” alert
    alert("ğŸ¤·â€â™‚ï¸í•´ë‹¹ì¼ì— íœ´ê°€ì‹ ì²­ê°€ëŠ¥ì—¬ë¶€ë¥¼ í™•ì¸ì¤‘ì…ë‹ˆë‹¤, ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”."); 
    google.script.run.withSuccessHandler(function(overLimitDate) {
    var employeeIdValue = document.getElementById('employeeId').value;  
      if (overLimitDate) {
        alert(overLimitDate + "ì—ëŠ” ë”ì´ìƒ ì‹ ì²­í•˜ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤(7ê°œì‹ ì²­ì™„ë£Œ). ë‹¤ë¥¸ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”");
      } else {
        google.script.run.saveVacationDates(employeeId, dates);
        // íœ´ê°€ ì‹ ì²­ì„œê°€ ì •ìƒ ì œì¶œë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” alert
       alert("íœ´ê°€ì‹ ì²­ì„œê°€ ì •ìƒ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
       e.target.reset();
        // ì‚¬ë²ˆ ê°’ì„ ë‹¤ì‹œ ì„¤ì •
       document.getElementById('employeeId').value = employeeIdValue;
      }
    }).checkDateLimit(employeeId, dates);
  });
</script>
</body>
</html>


---------

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getNameByEmployeeId(employeeId) {
  var sheetId = "1R3pNd1l5EJmE0yW7cwUZAeBJkrC-XZHbX9KkCkXJ2gA";
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName('member');
  var data = sheet.getDataRange().getValues();
  
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] == employeeId) {
      return data[i][1]; // ì‚¬ë²ˆì— í•´ë‹¹í•˜ëŠ” ì´ë¦„ ë°˜í™˜
    }
  }
  return null; // ì¼ì¹˜í•˜ëŠ” ì‚¬ë²ˆì´ ì—†ì„ ê²½ìš° null ë°˜í™˜
}

function saveVacationDates(employeeId, dates) {
  var sheetId = "1R3pNd1l5EJmE0yW7cwUZAeBJkrC-XZHbX9KkCkXJ2gA";
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName('member');
  var data = sheet.getDataRange().getValues();
  
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] == employeeId) {
      var existingDates = data[i].slice(2); // ê¸°ì¡´ì— ì €ì¥ëœ ë‚ ì§œë“¤
      var combinedDates = existingDates.concat(dates).filter(Boolean); // ê¸°ì¡´ ë‚ ì§œì™€ ìƒˆë¡œìš´ ë‚ ì§œë¥¼ í•©ì¹¨
      for (var j = 0; j < combinedDates.length; j++) {
        sheet.getRange(i + 1, 3 + j).setValue(combinedDates[j]); // ë‚ ì§œ ì €ì¥
      }
      break;
    }
  }
}


function checkDateLimit(employeeId, dates) {
  var sheetId = "1R3pNd1l5EJmE0yW7cwUZAeBJkrC-XZHbX9KkCkXJ2gA";
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName('member');
  var data = sheet.getRange("C2:M51").getValues();
  
  var dateCount = {};

  // ê¸°ì¡´ì— ì €ì¥ëœ ë‚ ì§œë“¤ì„ ì¹´ìš´íŠ¸
  for (var i = 0; i < data.length; i++) {
    for (var j = 0; j < data[i].length; j++) {
      var date = data[i][j];
      if (date && date instanceof Date) { // ë‚ ì§œ ê°ì²´ì¸ì§€ í™•ì¸
        var formattedDate = Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyy-MM-dd");
        dateCount[formattedDate] = (dateCount[formattedDate] || 0) + 1;
      }
    }
  }

  Logger.log(dateCount); // ë¡œê¹… ì¶”ê°€

  // ì‚¬ìš©ìê°€ ì‹ ì²­í•˜ë ¤ëŠ” ë‚ ì§œë“¤ì„ ì¹´ìš´íŠ¸
  for (var i = 0; i < dates.length; i++) {
    dateCount[dates[i]] = (dateCount[dates[i]] || 0) + 1;
    if (dateCount[dates[i]] > 7) {
      return dates[i]; // 7ê°œë¥¼ ì´ˆê³¼í•˜ëŠ” ë‚ ì§œ ë°˜í™˜
    }
  }

  return null; // ëª¨ë“  ë‚ ì§œê°€ ì œí•œ ë‚´ì— ìˆì„ ê²½ìš° null ë°˜í™˜
}

function getVacationRequests(employeeId) {
  var ss = SpreadsheetApp.openById("1R3pNd1l5EJmE0yW7cwUZAeBJkrC-XZHbX9KkCkXJ2gA");
  var sheet = ss.getSheetByName("member");
  var range = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn());
  var values = range.getValues();
  
  for (var i = 0; i < values.length; i++) {
    if (values[i][0] == employeeId) {
      var requests = [];
      for (var j = 2; j < values[i].length; j++) {
        if (values[i][j]) {
          // ë‚ ì§œ ê°’ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
          var dateValue = values[i][j];
          if (dateValue instanceof Date) {
            var yyyy = dateValue.getFullYear();
            var mm = String(dateValue.getMonth() + 1).padStart(2, '0'); // January is 0!
            var dd = String(dateValue.getDate()).padStart(2, '0');
            var formattedDate = yyyy + '-' + mm + '-' + dd;
            requests.push(formattedDate);
          } else {
            requests.push(values[i][j]);
          }
        }
      }
      return requests;
    }
  }
  return [];
}


